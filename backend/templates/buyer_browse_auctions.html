{% extends "base.html" %}

{% block title %}Browse Auctions - Telhan Sathi{% endblock %}

{% block content %}
<style>
    .browse-container {
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .filters-section {
        background: white;
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .filter-group {
        margin-bottom: 10px;
    }

    .filter-group label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
        text-transform: uppercase;
    }

    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        box-sizing: border-box;
    }

    .filter-buttons {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .filter-btn {
        flex: 1;
        padding: 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.3s;
    }

    .filter-btn.search {
        background: #388e3c;
        color: white;
    }

    .filter-btn.reset {
        background: #f0f0f0;
        color: #333;
    }

    .filter-btn:hover {
        opacity: 0.9;
    }

    .content-area {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .sort-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-size: 13px;
        color: #666;
    }

    .sort-select {
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        background: white;
    }

    .auctions-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .auction-card {
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        transition: all 0.3s;
        cursor: pointer;
    }

    .auction-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: #388e3c;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
    }

    .crop-name {
        font-size: 15px;
        font-weight: 600;
        color: #1e3a24;
        flex: 1;
    }

    .status-badge {
        background: #4caf50;
        color: white;
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
        white-space: nowrap;
        margin-left: 8px;
    }

    .card-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 10px 0;
        font-size: 12px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
    }

    .info-label {
        color: #999;
        font-weight: 500;
    }

    .info-value {
        color: #1e3a24;
        font-weight: 600;
    }

    .price-highlight {
        color: #d32f2f;
        font-size: 14px;
        font-weight: 700;
    }

    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #f0f0f0;
    }

    .farmer-info {
        font-size: 11px;
        color: #999;
    }

    .bid-button {
        background: #388e3c;
        color: white;
        border: none;
        padding: 6px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        transition: background 0.3s;
    }

    .bid-button:hover {
        background: #2d5735;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #999;
    }

    .empty-icon {
        font-size: 48px;
        margin-bottom: 10px;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
        align-items: center;
    }

    .pagination button {
        padding: 6px 10px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .pagination button.active {
        background: #388e3c;
        color: white;
        border-color: #388e3c;
    }

    .time-remaining {
        background: #fff3cd;
        color: #856404;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 500;
    }

    @media (max-width: 600px) {
        .card-body {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="browse-container">
    <!-- Header -->
    <div class="header">
        <div>
            <h1 class="header-title">Browse Auctions</h1>
            <p class="header-subtitle">Find & Place Bids</p>
        </div>
        <button class="header-btn" onclick="window.location.href='/bidding/buyer/dashboard'">‚Üê</button>
    </div>

    <!-- Filters -->
    <div class="filters-section">
        <div class="filter-group">
            <label>Crop Name</label>
            <input type="text" id="cropFilter" placeholder="e.g., Mustard, Groundnut...">
        </div>
        <div class="filter-group">
            <label>District</label>
            <input type="text" id="districtFilter" placeholder="e.g., Nashik, Pune...">
        </div>
        <div class="filter-buttons">
            <button class="filter-btn search" onclick="searchAuctions()">üîç Search</button>
            <button class="filter-btn reset" onclick="resetFilters()">‚Ü∫ Reset</button>
        </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Sort Header -->
        <div class="sort-header">
            <span>Showing <strong id="result-count">0</strong> auctions</span>
            <select class="sort-select" id="sortSelect" onchange="sortAuctions()">
                <option value="newest">Newest First</option>
                <option value="price-high">Highest Price</option>
                <option value="price-low">Lowest Price</option>
                <option value="bids">Most Bids</option>
            </select>
        </div>

        <!-- Auctions Grid -->
        <div class="auctions-grid" id="auctionsContainer">
            <div class="loading">üîç Loading auctions...</div>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="paginationContainer" style="display: none;">
            <button onclick="previousPage()">‚Üê Prev</button>
            <span id="pageInfo"></span>
            <button onclick="nextPage()">Next ‚Üí</button>
        </div>
    </div>
</div>

<script>
    let currentPage = 1;
    let totalPages = 1;
    let currentSort = 'newest';

    // Search auctions
    async function searchAuctions(page = 1) {
        const crop = document.getElementById('cropFilter').value.trim();
        const district = document.getElementById('districtFilter').value.trim();

        try {
            let url = `/bidding/buyer/auctions/api?page=${page}`;
            if (crop) url += `&crop=${encodeURIComponent(crop)}`;
            if (district) url += `&district=${encodeURIComponent(district)}`;

            const response = await fetch(url);
            const data = await response.json();

            displayAuctions(data.auctions);
            currentPage = data.page;
            totalPages = data.pages;
            document.getElementById('result-count').textContent = data.total;

            // Show pagination if needed
            if (totalPages > 1) {
                document.getElementById('paginationContainer').style.display = 'flex';
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            } else {
                document.getElementById('paginationContainer').style.display = 'none';
            }

            if (data.auctions.length === 0) {
                document.getElementById('auctionsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p>No auctions found matching your criteria</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error searching auctions:', error);
            document.getElementById('auctionsContainer').innerHTML = `
                <div class="empty-state">
                    <p>‚ùå Error loading auctions</p>
                </div>
            `;
        }
    }

    // Display auctions
    function displayAuctions(auctions) {
        const container = document.getElementById('auctionsContainer');

        if (auctions.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <p>No auctions found</p>
                </div>
            `;
            return;
        }

        // Sort auctions if needed
        let sorted = [...auctions];
        if (currentSort === 'price-high') {
            sorted.sort((a, b) => b.highest_bid - a.highest_bid);
        } else if (currentSort === 'price-low') {
            sorted.sort((a, b) => a.highest_bid - b.highest_bid);
        } else if (currentSort === 'bids') {
            sorted.sort((a, b) => b.bids_count - a.bids_count);
        }

        container.innerHTML = sorted.map(auction => {
            const timeRemaining = formatTimeRemaining(auction.time_remaining);
            const isEndingSoon = auction.time_remaining < 3600; // Less than 1 hour

            return `
                <div class="auction-card" onclick="goToAuctionDetails('${auction.id}')">
                    <div class="card-header">
                        <div class="crop-name">${auction.crop_name}</div>
                        <div class="status-badge">Active</div>
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <span class="info-label">Current Price</span>
                            <span class="info-value price-highlight">‚Çπ${auction.highest_bid}/q</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Bids</span>
                            <span class="info-value">${auction.bids_count}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Quantity</span>
                            <span class="info-value">${auction.quantity_quintals}q</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Grade</span>
                            <span class="info-value">${auction.quality_grade}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location</span>
                            <span class="info-value">${auction.district}</span>
                        </div>
                        ${isEndingSoon ? `<div class="time-remaining">‚è∞ Ending soon!</div>` : ''}
                    </div>
                    <div class="card-footer">
                        <span class="farmer-info">üë®‚Äçüåæ ${auction.farmer_name}</span>
                        <button class="bid-button" onclick="event.stopPropagation(); goToAuctionDetails('${auction.id}')">
                            Bid Now ‚Üí
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Format time remaining
    function formatTimeRemaining(seconds) {
        if (seconds < 60) return 'Ending now';
        if (seconds < 3600) return Math.floor(seconds / 60) + 'm left';
        if (seconds < 86400) return Math.floor(seconds / 3600) + 'h left';
        return Math.floor(seconds / 86400) + 'd left';
    }

    // Reset filters
    function resetFilters() {
        document.getElementById('cropFilter').value = '';
        document.getElementById('districtFilter').value = '';
        currentPage = 1;
        searchAuctions();
    }

    // Sort auctions
    function sortAuctions() {
        currentSort = document.getElementById('sortSelect').value;
        searchAuctions(currentPage);
    }

    // Pagination
    function nextPage() {
        if (currentPage < totalPages) {
            searchAuctions(currentPage + 1);
            document.querySelector('.content-area').scrollTop = 0;
        }
    }

    function previousPage() {
        if (currentPage > 1) {
            searchAuctions(currentPage - 1);
            document.querySelector('.content-area').scrollTop = 0;
        }
    }

    // Navigate to auction details
    function goToAuctionDetails(auctionId) {
        window.location.href = `/bidding/buyer/auction/${auctionId}`;
    }

    // Initial load
    window.addEventListener('load', () => {
        searchAuctions();
    });
</script>

{% endblock %}
