{% extends "base.html" %}

{% block title %}‡§≤‡§æ‡§≠ ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§ü‡§∞ - ‡§§‡•á‡§≤‡§π‡§® ‡§∏‡§æ‡§•‡•Ä{% endblock %}

{% block content %}

        <!-- Loader Overlay -->
        <div id="loaderOverlay" class="loader-overlay">
            <div class="spinner"></div>
            <div class="loader-text">‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§®‡•Å‡§Æ‡§æ‡§® ‡§ï‡•Ä ‡§ó‡§£‡§®‡§æ ‡§ú‡§æ‡§∞‡•Ä ‡§π‡•à...</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Summary Card -->
            <div class="card">
                <h2 class="card-title">üåæ ‡§§‡§ø‡§≤‡§π‡§® ‡§≤‡§æ‡§≠ ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</h2>
                <div id="summary-line" class="summary-text">‡§Ü‡§™‡§ï‡§æ ‡§ñ‡•á‡§§ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶</div>
                
                <!-- Error Message -->
                <div id="errorMessage" class="error-message">
                    <div class="error-title" id="errorTitle">‡§§‡•ç‡§∞‡•Å‡§ü‡§ø</div>
                    <div class="error-details" id="errorDetails"></div>
                </div>
            </div>

            <!-- Input Section -->
            <div class="card">
                <h3 class="card-subtitle">‡§§‡§ø‡§≤‡§π‡§® ‡§´‡§∏‡§≤ ‡§î‡§∞ ‡§™‡•à‡§∞‡§æ‡§Æ‡•Ä‡§ü‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç</h3>
                
                <!-- Market and Commodity Selection -->
                <div class="row">
                    <div class="col">
                        <label>‡§¨‡§æ‡§ú‡§æ‡§∞ (‡§Æ‡§Ç‡§°‡•Ä)</label>
                        <select id="marketSelect" class="input-field" onchange="updateCommodities()"></select>
                    </div>
                    <div class="col">
                        <label>‡§§‡§ø‡§≤‡§π‡§® ‡§´‡§∏‡§≤</label>
                        <select id="commoditySelect" class="input-field"></select>
                    </div>
                </div>
                
                <!-- Area, Cost, and Harvest Month -->
                <div class="row">
                    <div class="col">
                        <label>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ (‡§è‡§ï‡§°‡§º)</label>
                        <input id="areaAcres" class="input-field" type="number" min="0.1" max="100" step="0.1" value="1">
                    </div>
                    <div class="col">
                        <label>‡§≤‡§æ‡§ó‡§§ ‡§™‡•ç‡§∞‡§§‡§ø ‡§è‡§ï‡§°‡§º (‚Çπ)</label>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <input id="costPerAcre" class="input-field" type="number" min="1000" max="100000" step="100" value="20000">
                            <span id="costHint" class="cost-hint" style="font-size: 11px; color: #666; white-space: nowrap;">‡§Æ‡§æ‡§®‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø</span>
                        </div>
                    </div>
                    <div class="col">
                        <label>‡§ï‡§ü‡§æ‡§à ‡§ï‡§æ ‡§Æ‡§π‡•Ä‡§®‡§æ</label>
                        <select id="harvestMonth" class="input-field"></select>
                    </div>
                    <div class="col" style="display: flex; align-items: flex-end;">
                        <button class="btn btn-simulate" id="simulateBtn" onclick="simulate()">
                            üìä ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Grid -->
            <div class="card">
                <h3 class="card-subtitle">üìä ‡§≤‡§æ‡§≠ ‡§ï‡§æ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®</h3>
                <div class="result-grid">
                    <div class="result-box price-box">
                        <div class="result-value" id="currentPriceVal">-</div>
                        <div class="result-label">‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤)</div>
                    </div>
                    <div class="result-box price-box">
                        <div class="result-value" id="forecastPriceVal">-</div>
                        <div class="result-label">‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®‡§ø‡§§ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (‚Çπ/‡§ï‡•ç‡§µ‡§ø‡§Ç‡§ü‡§≤)</div>
                    </div>
                    <div class="result-box income-box">
                        <div class="result-value" id="totalRevenueVal">-</div>
                        <div class="result-label">‡§ï‡•Å‡§≤ ‡§Ü‡§Ø (‚Çπ)</div>
                    </div>
                    <div class="result-box cost-box">
                        <div class="result-value" id="totalCostVal">-</div>
                        <div class="result-label">‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§ (‚Çπ)</div>
                    </div>
                </div>
            </div>

            <!-- Profit Breakdown Chart -->
            <div class="card">
                <h3 class="card-subtitle">üìà ‡§Ü‡§Ø ‡§î‡§∞ ‡§≤‡§æ‡§ó‡§§ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</h3>
                <div class="chart-container">
                    <canvas id="profitChart"></canvas>
                </div>
            </div>

            <!-- Profit Analysis Metrics -->
            <div class="card">
                <h3 class="card-subtitle">üíπ ‡§≤‡§æ‡§≠ ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</h3>
                <div class="profit-metrics">
                    <div class="metric-item roi-metric">
                        <div class="metric-label">ROI (‡§∞‡§ø‡§ü‡§∞‡•ç‡§®)</div>
                        <div class="metric-value" id="roiVal">-</div>
                    </div>
                    <div class="metric-item margin-metric">
                        <div class="metric-label">‡§≤‡§æ‡§≠ ‡§Æ‡§æ‡§∞‡•ç‡§ú‡§ø‡§®</div>
                        <div class="metric-value" id="marginVal">-</div>
                    </div>
                    <div class="metric-item trend-metric">
                        <div class="metric-label">‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§™‡•ç‡§∞‡§µ‡•É‡§§‡•ç‡§§‡§ø</div>
                        <div class="metric-value" id="trendVal">-</div>
                    </div>
                    <div class="metric-item breakeven-metric">
                        <div class="metric-label">‡§¨‡•ç‡§∞‡•á‡§ï‡§à‡§µ‡§® ‡§¶‡§ø‡§®</div>
                        <div class="metric-value" id="breakEvenVal">-</div>
                    </div>
                </div>
                <div class="profit-summary">
                    <div class="net-profit-display" id="netProfitDisplay">‚Çπ -</div>
                    <div class="net-profit-label">‡§∂‡•Å‡§¶‡•ç‡§ß ‡§≤‡§æ‡§≠ (30 ‡§¶‡§ø‡§®)</div>
                </div>
            </div>

            <!-- CTA Buttons -->
            <div class="card">
                <div class="button-group">
                    <button class="btn btn-primary" id="applySubsidy">‡§∏‡§¨‡•ç‡§∏‡§ø‡§°‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§µ‡•á‡§¶‡§® ‡§ï‡§∞‡•á‡§Ç</button>
                    <button class="btn btn-secondary" id="findBuyer">‡§ñ‡§∞‡•Ä‡§¶‡§æ‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç</button>
                </div>
            </div>
        </div>

        <style>
    


            .icon-button {
                width: 24px;
                height: 24px;
                fill: white;
                cursor: pointer;
            }

            .main-content {
                flex-grow: 1;
                overflow-y: auto;
                padding: 8px;
                padding-bottom: 80px;
            }

            .card {
                background: #fff;
                padding: 16px;
                border-radius: 10px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                margin-bottom: 15px;
            }

            .card-title {
                margin: 0 0 8px 0;
                font-size: 18px;
                font-weight: 600;
                color: #333;
            }

            .card-subtitle {
                margin: 0 0 12px 0;
                font-size: 15px;
                font-weight: 600;
                color: #333;
            }

            .summary-text {
                font-size: 13px;
                color: #666;
                line-height: 1.6;
            }

            .row {
                display: flex;
                gap: 12px;
                margin-bottom: 12px;
                align-items: flex-end;
            }

            .col {
                flex: 1;
            }

            label {
                font-size: 12px;
                color: #666;
                display: block;
                margin-bottom: 4px;
                font-weight: 500;
            }

            .input-field {
                width: 100%;
                padding: 10px;
                border-radius: 6px;
                border: 1px solid #ddd;
                font-size: 13px;
                transition: border-color 0.2s;
            }

            .input-field:focus {
                outline: none;
                border-color: #388e3c;
                box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.1);
            }

            .result-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }

            .profit-metrics {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 12px;
                margin-bottom: 16px;
            }

            .metric-item {
                background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
                padding: 12px;
                border-radius: 8px;
                text-align: center;
                border-left: 3px solid #388e3c;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            }

            .metric-item.roi-metric { border-left-color: #2196f3; }
            .metric-item.margin-metric { border-left-color: #388e3c; }
            .metric-item.trend-metric { border-left-color: #ff9800; }
            .metric-item.breakeven-metric { border-left-color: #f44336; }

            .metric-label {
                font-size: 10px;
                color: #999;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .metric-value {
                font-size: 16px;
                font-weight: bold;
                color: #333;
                margin-top: 4px;
            }

            .result-box {
                background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
                padding: 14px;
                border-radius: 8px;
                text-align: center;
                border-left: 4px solid #388e3c;
                box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
            }

            .result-box.yield-box {
                border-left-color: #ffc107;
            }

            .result-box.price-box {
                border-left-color: #ff9800;
            }

            .result-box.cost-box {
                border-left-color: #f44336;
            }

            .result-box.income-box {
                border-left-color: #2196f3;
            }

            .result-value {
                font-size: 18px;
                font-weight: bold;
                color: #388e3c;
            }

            .result-label {
                font-size: 11px;
                color: #666;
                margin-top: 4px;
            }

            .chart-container {
                position: relative;
                height: 300px;
                margin: 16px 0 8px 0;
                padding: 12px;
                background: linear-gradient(135deg, #fafbfc 0%, #f5f7fa 100%);
                border-radius: 8px;
                border: 1px solid #e8eef2;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            }

            .profit-summary {
                text-align: center;
                margin-top: 12px;
                padding: 12px;
                background: #f0f7f0;
                border-radius: 8px;
            }

            .net-profit-display {
                font-size: 24px;
                font-weight: bold;
                color: #2e7d32;
            }

            .net-profit-label {
                font-size: 12px;
                color: #666;
                margin-top: 4px;
            }

            .button-group {
                display: flex;
                gap: 12px;
            }

            .btn {
                padding: 12px 16px;
                border-radius: 8px;
                border: none;
                cursor: pointer;
                font-weight: 600;
                font-size: 14px;
                flex: 1;
                transition: all 0.3s ease;
            }

            .btn-simulate {
                padding: 10px 20px;
                background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
                color: #fff;
                flex: 0.8;
                min-width: 120px;
                box-shadow: 0 2px 8px rgba(56, 142, 60, 0.3);
                font-size: 13px;
            }

            .btn-simulate:hover {
                background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(56, 142, 60, 0.4);
            }

            .btn-simulate:active {
                transform: translateY(0);
            }

            .btn-primary {
                background: #388e3c;
                color: #fff;
            }

            .btn-primary:hover {
                background: #2e7d32;
                box-shadow: 0 2px 8px rgba(56, 142, 60, 0.3);
            }

            .btn-secondary {
                background: #fff;
                border: 2px solid #388e3c;
                color: #388e3c;
            }

            .btn-secondary:hover {
                background: #f0f7f0;
                border-color: #2e7d32;
                color: #2e7d32;
            }

            @media (max-width: 420px) {
                .row {
                    flex-direction: column;
                }

                .col {
                    width: 100%;
                }
            }

            /* Spinner and Loader Styles */
            .loader-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.4);
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            }

            .loader-overlay.active {
                display: flex;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top-color: #fff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .loader-text {
                color: #fff;
                font-size: 16px;
                margin-top: 20px;
                text-align: center;
                font-weight: 500;
            }

            .error-message {
                background: #ffebee;
                border-left: 4px solid #f44336;
                color: #c62828;
                padding: 12px;
                border-radius: 4px;
                margin: 10px 0;
                font-size: 13px;
                display: none;
            }

            .error-message.show {
                display: block;
            }

            .error-title {
                font-weight: 600;
                margin-bottom: 4px;
            }

            .error-details {
                font-size: 12px;
                color: #d32f2f;
            }
        </style>
{% endblock %}

{% block script %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        let farmer = null;
        let availableMarkets = [];
        let availableCommodities = [];
        let harvestMonths = [];
        let mlAvailable = false;
        let profitChart = null;  // Chart.js instance

        // Standard costs per acre for each commodity (in INR)
        const standardCosts = {
            'Groundnut': 25000,
            'Linseed (Flaxseed)': 17000,
            'Mustard': 18000,
            'Sesame': 19000,
            'Soybean': 20000
        };

        const hindiMonths = {
            'January': '‡§ú‡§®‡§µ‡§∞‡•Ä', 'February': '‡§´‡§∞‡§µ‡§∞‡•Ä', 'March': '‡§Æ‡§æ‡§∞‡•ç‡§ö', 'April': '‡§Ö‡§™‡•ç‡§∞‡•à‡§≤',
            'May': '‡§Æ‡§à', 'June': '‡§ú‡•Ç‡§®', 'July': '‡§ú‡•Å‡§≤‡§æ‡§à', 'August': '‡§Ö‡§ó‡§∏‡•ç‡§§',
            'September': '‡§∏‡§ø‡§§‡§Ç‡§¨‡§∞', 'October': '‡§Ö‡§ï‡•ç‡§ü‡•Ç‡§¨‡§∞', 'November': '‡§®‡§µ‡§Ç‡§¨‡§∞', 'December': '‡§¶‡§ø‡§∏‡§Ç‡§¨‡§∞'
        };

        const hindiCommodities = {
            'Groundnut': '‡§Æ‡•Ç‡§Ç‡§ó‡§´‡§≤‡•Ä',
            'Linseed (Flaxseed)': '‡§Ö‡§≤‡§∏‡•Ä',
            'Mustard': '‡§∏‡§∞‡§∏‡•ã‡§Ç',
            'Sesame': '‡§§‡§ø‡§≤',
            'Soybean': '‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®'
        };

        const trendEmojis = {
            'Uptrend': 'üìà ‡§ä‡§™‡§∞ ‡§ï‡•Ä ‡§ì‡§∞',
            'Downtrend': 'üìâ ‡§®‡•Ä‡§ö‡•á ‡§ï‡•Ä ‡§ì‡§∞',
            'Stable': '‚û°Ô∏è ‡§∏‡•ç‡§•‡§ø‡§∞'
        };

        function updateCommodities() {
            const marketSelect = document.getElementById('marketSelect');
            const commoditySelect = document.getElementById('commoditySelect');
            const costPerAcreField = document.getElementById('costPerAcre');
            const costHint = document.getElementById('costHint');
            const selectedMarket = marketSelect.value;

            // Get commodities for this market from the available commodities
            // In this case, all markets have same commodities, but we keep the function for future flexibility
            
            // Clear existing options
            commoditySelect.innerHTML = '';

            const commodities = availableCommodities || ['Soybean'];
            
            commodities.forEach(commodity => {
                const opt = document.createElement('option');
                opt.value = commodity;
                opt.textContent = hindiCommodities[commodity] || commodity;
                commoditySelect.appendChild(opt);
            });

            // Select first commodity
            if (commodities.length > 0) {
                commoditySelect.value = commodities[0];
                updateCostField(commodities[0]);
            }
        }

        function updateCostField(commodity) {
            const costPerAcreField = document.getElementById('costPerAcre');
            const costHint = document.getElementById('costHint');
            
            const standardCost = standardCosts[commodity] || 20000;
            costPerAcreField.value = standardCost;
            costHint.textContent = '‡§Æ‡§æ‡§®‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Standard)';
            
            // Change hint color when user edits the cost
            costPerAcreField.addEventListener('change', () => {
                const currentValue = parseFloat(costPerAcreField.value);
                if (currentValue !== standardCost) {
                    costHint.textContent = '‡§ï‡§∏‡•ç‡§ü‡§Æ (Custom)';
                    costHint.style.color = '#ff9800';
                } else {
                    costHint.textContent = '‡§Æ‡§æ‡§®‡§ï ‡§Æ‡•Ç‡§≤‡•ç‡§Ø (Standard)';
                    costHint.style.color = '#666';
                }
            }, {once: true});
        }

        async function init() {
            try {
                const res = await fetch('/profit/api/init', {credentials: 'same-origin'});
                const data = await res.json();
                if (data.error) { 
                    document.getElementById('summary-line').textContent = '‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + data.error; 
                    return; 
                }
                
                farmer = data.farmer;
                availableMarkets = data.available_markets || [];
                availableCommodities = data.available_commodities || [];
                harvestMonths = data.harvest_months || [];
                mlAvailable = data.ml_available || false;

                // Update summary with Hindi
                document.getElementById('summary-line').textContent = 
                    `‡§ñ‡•á‡§§: ${farmer.name} | ‡§Æ‡§Ç‡§°‡•Ä: ${farmer.market} | ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä: ${farmer.soil_type || 'N/A'} | ‡§ú‡§≤: ${farmer.water_type || 'N/A'}`;

                // Populate market dropdown
                const marketSel = document.getElementById('marketSelect');
                availableMarkets.forEach(market => {
                    const opt = document.createElement('option');
                    opt.value = market;
                    opt.textContent = market;
                    marketSel.appendChild(opt);
                });
                marketSel.value = farmer.market || (availableMarkets[0] || 'Delhi');

                // Populate commodity dropdown (dependent on market)
                updateCommodities();
                const commoditySel = document.getElementById('commoditySelect');
                commoditySel.value = farmer.current_crop || (availableCommodities[0] || 'Soybean');
                
                // Update cost field when commodity changes
                commoditySel.addEventListener('change', () => {
                    updateCostField(commoditySel.value);
                });
                
                // Set initial cost based on selected commodity
                updateCostField(commoditySel.value);

                // Populate harvest month dropdown with Hindi names
                const harvestSel = document.getElementById('harvestMonth');
                harvestMonths.forEach(month => {
                    const opt = document.createElement('option');
                    opt.value = month;
                    opt.textContent = hindiMonths[month] || month;
                    harvestSel.appendChild(opt);
                });
                harvestSel.value = farmer.harvest_month || 'October';

                // Set area from farmer data
                document.getElementById('areaAcres').value = farmer.area_in_acres || 1;

                // Event listeners
                document.getElementById('applySubsidy').addEventListener('click', () => {
                    window.location.href = '/subsidies/list';
                });
                document.getElementById('findBuyer').addEventListener('click', () => {
                    alert('Marketplace has been removed. Please use the Bidding System to sell your crops.');
                });

                // Show initial message in Hindi
                document.getElementById('summary-line').textContent =
                    `${farmer.name} ‚Ä¢ ${farmer.market} ‚Ä¢ ‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡§ø‡§Æ‡•Å‡§≤‡•á‡§ü ‡§¨‡§ü‡§® ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç`;
            } catch (e) {
                document.getElementById('summary-line').textContent = '‡§ñ‡•á‡§§ ‡§ï‡§æ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ' + e.message;
            }
        }

        async function simulate() {
            try {
                // Clear previous error
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.classList.remove('show');

                const market = document.getElementById('marketSelect').value;
                const commodity = document.getElementById('commoditySelect').value;
                const areaAcres = parseFloat(document.getElementById('areaAcres').value || 1);
                const harvestMonth = document.getElementById('harvestMonth').value;
                const costPerAcre = parseFloat(document.getElementById('costPerAcre').value || 20000);

                if (!market || !commodity) {
                    showError('‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ ‡§≠‡§∞‡•á‡§Ç', '‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§ú‡§æ‡§∞ ‡§î‡§∞ ‡§´‡§∏‡§≤ ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§ö‡•Å‡§®‡•á‡§Ç');
                    return;
                }

                // Show loader
                document.getElementById('loaderOverlay').classList.add('active');

                const payload = {
                    market: market,
                    commodity: commodity,
                    area_in_acres: areaAcres,
                    harvest_month: harvestMonth,
                    custom_cost_per_acre: costPerAcre
                };

                const res = await fetch('/profit/api/simulate', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                // Hide loader
                document.getElementById('loaderOverlay').classList.remove('active');

                const out = await res.json();
                
                // Check for API error
                if (out.error) {
                    console.error('API error:', out);
                    showError(out.error, out.details || '');
                    return;
                }

                // Check for HTTP error
                if (!res.ok) {
                    showError('‡§∏‡§∞‡•ç‡§µ‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', `‡§§‡•ç‡§∞‡•Å‡§ü‡§ø ‡§ï‡•ã‡§°: ${res.status}`);
                    return;
                }

                const pred = out.prediction;
                const hindiCommodityName = hindiCommodities[commodity] || commodity;

                // Update result boxes
                document.getElementById('currentPriceVal').textContent = '‚Çπ ' + Math.round(pred.price_current || 0).toLocaleString('en-IN');
                document.getElementById('forecastPriceVal').textContent = '‚Çπ ' + Math.round(pred.forecast_price || 0).toLocaleString('en-IN');
                document.getElementById('totalRevenueVal').textContent = '‚Çπ ' + Math.round(pred.gross_revenue || 0).toLocaleString('en-IN');
                document.getElementById('totalCostVal').textContent = '‚Çπ ' + Math.round(pred.total_cost || 0).toLocaleString('en-IN');

                // Update metrics
                document.getElementById('roiVal').textContent = pred.roi || '0%';
                document.getElementById('marginVal').textContent = pred.profit_margin || '0%';
                document.getElementById('trendVal').textContent = trendEmojis[pred.price_trend] || pred.price_trend || '?';
                document.getElementById('breakEvenVal').textContent = (pred.breakeven_months || 0) + ' ‡§¶‡§ø‡§®';

                // Update profit display
                document.getElementById('netProfitDisplay').textContent = '‚Çπ ' + Math.round(pred.net_profit || 0).toLocaleString('en-IN');

                // Update summary line with AI indicator
                document.getElementById('summary-line').textContent = 
                    `${hindiCommodityName} ‚Ä¢ ${market} ‚Ä¢ ‡§≤‡§æ‡§≠: ‚Çπ${Math.round(pred.net_profit || 0).toLocaleString('en-IN')} ‚Ä¢ AI: ‚úÖ`;

                // Update chart with profit breakdown
                updateChart(pred, hindiCommodityName);

            } catch (e) {
                console.error('Simulate error:', e);
                document.getElementById('loaderOverlay').classList.remove('active');
                showError('‡§Ö‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡§æ‡§∂‡§ø‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø', e.message);
            }
        }

        function showError(title, details) {
            const errorMsg = document.getElementById('errorMessage');
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorDetails').textContent = details;
            errorMsg.classList.add('show');
        }

        function updateChart(prediction, commodity) {
            const ctx = document.getElementById('profitChart');
            if (!ctx) return;  // Chart element not available
            
            const revenue = prediction.gross_revenue || 0;
            const cost = prediction.total_cost || 0;
            const profit = prediction.net_profit || 0;
            
            // Destroy previous chart if it exists
            if (profitChart) {
                profitChart.destroy();
            }
            
            // Create new chart with improved styling
            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['‡§Ü‡§Ø (Revenue)', '‡§≤‡§æ‡§ó‡§§ (Cost)', '‡§≤‡§æ‡§≠ (Profit)'],
                    datasets: [{
                        label: commodity,
                        data: [revenue, cost, profit],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.85)',    // Vibrant green for revenue
                            'rgba(244, 67, 54, 0.85)',    // Vibrant red for cost
                            'rgba(33, 150, 243, 0.85)'    // Vibrant blue for profit
                        ],
                        borderColor: [
                            'rgba(56, 142, 60, 1)',       // Darker green
                            'rgba(211, 47, 47, 1)',       // Darker red
                            'rgba(21, 101, 192, 1)'       // Darker blue
                        ],
                        borderWidth: 2.5,
                        borderRadius: 6,
                        hoverBackgroundColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(244, 67, 54, 1)',
                            'rgba(33, 150, 243, 1)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {size: 13, weight: 600},
                                padding: 16,
                                color: '#333',
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.85)',
                            padding: 12,
                            titleFont: {size: 13, weight: 'bold'},
                            bodyFont: {size: 12},
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const value = Math.round(context.parsed.y);
                                    return '‚Çπ ' + value.toLocaleString('en-IN');
                                },
                                afterLabel: function(context) {
                                    const total = revenue + cost;
                                    const percentage = ((context.parsed.y / total) * 100).toFixed(1);
                                    return percentage + '% of total';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Çπ ' + (value / 1000).toFixed(0) + 'k';
                                },
                                font: {size: 11, weight: 500},
                                color: '#666',
                                padding: 8
                            },
                            grid: {
                                color: 'rgba(200, 200, 200, 0.15)',
                                drawBorder: false,
                                lineWidth: 1
                            }
                        },
                        x: {
                            ticks: {
                                font: {size: 12, weight: 600},
                                color: '#333',
                                padding: 8
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function goBack() {
            window.history.back();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
{% endblock %}
